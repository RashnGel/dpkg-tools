#!/bin/bash -e

DATADIR="<%= app_install_path %>"

# Create a group for the app if it isn't already there
if ! getent group "<%= init_name %>" >/dev/null; then
	# Adding system group for the app: <%= init_name %>.
	addgroup --system "<%= init_name %>" >/dev/null
fi

# Create a user for the app if it isn't already there
if ! getent passwd <%= init_name %> >/dev/null; then
	# Adding system user: <%= init_name %>.
	adduser \
	  --system \
	  --disabled-login \
	  --ingroup <%= init_name %> \
	  --home $DATADIR \
	  --gecos "<%= init_name %> Rails app" \
	  --shell /bin/bash \
	  <%= init_name %>  >/dev/null
fi

# Create the app's home dir, if it isn't there already...
if [ ! -d $DATADIR -a ! -L $DATADIR ]; then
 	mkdir -p $DATADIR
fi

# Fix ownership of the app's home dir...
# The "set +e" is necessary as e.g. a ".journal" of a ext3 partition is
# not chgrp'able (#318435). [nicked from mysql-server 5's pre-inst]
set +e
chown app-name:app-name $DATADIR
find $DATADIR -follow -not -group "<%= init_name %>" -print0 2>/dev/null \
  | xargs -0 --no-run-if-empty chgrp "<%= init_name %>"
set -e
